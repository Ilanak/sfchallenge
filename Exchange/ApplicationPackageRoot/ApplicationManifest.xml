<?xml version="1.0" encoding="utf-8"?>
<ApplicationManifest xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ApplicationTypeName="ExchangeType" ApplicationTypeVersion="1.0.0" xmlns="http://schemas.microsoft.com/2011/01/fabric">
  <Parameters>
    <!-- Cluster parameters -->
    <Parameter Name="ReverseProxy_Port" DefaultValue="19081" />
    <!-- Logger parameters -->
    <Parameter Name="Logger_MinReplicaSetSize" DefaultValue="3" />
    <Parameter Name="Logger_PartitionCount" DefaultValue="1" />
    <Parameter Name="Logger_DnsName" DefaultValue="logger.exchange" />
    <Parameter Name="Logger_Port" DefaultValue="9082" />
    <Parameter Name="Logger_TargetReplicaSetSize" DefaultValue="3" />
    <Parameter Name="CosmosDBConnectionString" DefaultValue="" />
    <!-- UserStore parameters -->
    <Parameter Name="UserStore_MinReplicaSetSize" DefaultValue="3" />
    <Parameter Name="UserStore_PartitionCount" DefaultValue="1" />
    <Parameter Name="UserStore_TargetReplicaSetSize" DefaultValue="3" />
    <!-- Fulfillment parameters -->
    <Parameter Name="Fulfillment_MinReplicaSetSize" DefaultValue="3" />
    <Parameter Name="Fulfillment_PartitionCount" DefaultValue="1" />
    <Parameter Name="Fulfillment_TargetReplicaSetSize" DefaultValue="3" />
    <Parameter Name="Fulfillment_DnsName" DefaultValue="fulfillment.exchange" />
    <Parameter Name="Fulfillment_Port" DefaultValue="9080" />
    <!-- OrderBook parameters -->
    <Parameter Name="OrderBook_DnsName" DefaultValue="orderbook.exchange" />
    <Parameter Name="OrderBook_Port" DefaultValue="9081" />
    <Parameter Name="OrderBook_MinReplicaSetSize" DefaultValue="3" />
    <Parameter Name="OrderBook_PartitionCount" DefaultValue="1" />
    <Parameter Name="OrderBook_TargetReplicaSetSize" DefaultValue="3" />
    <!--
    You have an SLA with management to block new orders when 200 existing orders are pending
    Changing this value with fail a system audit. Other approaches much be used to scale 
    -->
    <Parameter Name="OrderBook_MaxBidsPending" DefaultValue="200" />
    <Parameter Name="OrderBook_MaxAsksPending" DefaultValue="200" />
  </Parameters>
  <!-- Import Service Manifests -->
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="LoggerPkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides>
      <ConfigOverride Name="Config">
        <Settings>
          <Section Name="CosmosDB">
            <Parameter Name="ConnectionString" Value="[CosmosDBConnectionString]" />
          </Section>
        </Settings>
      </ConfigOverride>
    </ConfigOverrides>
    <ResourceOverrides>
      <Endpoints>
        <Endpoint Name="ServiceEndpoint" Port="[Logger_Port]" />
      </Endpoints>
    </ResourceOverrides>
  </ServiceManifestImport>
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="UserStorePkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides />
  </ServiceManifestImport>
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="FulfillmentPkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides>
      <ConfigOverride Name="Config">
        <Settings>
          <Section Name="FulfillmentConfig">
            <Parameter Name="OrderBook_DnsName" Value="[OrderBook_DnsName]" />
            <Parameter Name="OrderBook_Port" Value="[OrderBook_Port]" />
            <Parameter Name="Logger_DnsName" Value="[Logger_DnsName]" />
            <Parameter Name="Logger_Port" Value="[Logger_Port]" />
          </Section>
        </Settings>
      </ConfigOverride>
    </ConfigOverrides>
    <ResourceOverrides>
      <Endpoints>
        <Endpoint Name="ServiceEndpoint" Port="[Fulfillment_Port]" />
      </Endpoints>
    </ResourceOverrides>
  </ServiceManifestImport>
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="OrderBookPkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides>
      <ConfigOverride Name="Config">
        <Settings>
          <Section Name="ClusterConfig">
            <Parameter Name="ReverseProxy_Port" Value="[ReverseProxy_Port]" />
          </Section>
          <Section Name="OrderBookConfig">
            <Parameter Name="MaxBidsPending" Value="[OrderBook_MaxBidsPending]" />
            <Parameter Name="MaxAsksPending" Value="[OrderBook_MaxAsksPending]" />
          </Section>
        </Settings>
      </ConfigOverride>
    </ConfigOverrides>
    <ResourceOverrides>
      <Endpoints>
        <Endpoint Name="ServiceEndpoint" Port="[OrderBook_Port]" />
      </Endpoints>
    </ResourceOverrides>
  </ServiceManifestImport>
  <DefaultServices>
    <!-- Create UserStore Service -->
    <Service Name="UserStore" ServicePackageActivationMode="ExclusiveProcess">
      <StatefulService ServiceTypeName="UserStoreType" TargetReplicaSetSize="[UserStore_TargetReplicaSetSize]" MinReplicaSetSize="[UserStore_MinReplicaSetSize]">
        <UniformInt64Partition PartitionCount="[UserStore_PartitionCount]" LowKey="-9223372036854775808" HighKey="9223372036854775807" />
      </StatefulService>
    </Service>
    <!-- Create Fulfillment Service -->
    <Service Name="Fulfillment" ServiceDnsName="fulfillment.exchange" ServicePackageActivationMode="ExclusiveProcess">
      <StatefulService ServiceTypeName="FulfillmentType" TargetReplicaSetSize="[Fulfillment_TargetReplicaSetSize]" MinReplicaSetSize="[Fulfillment_MinReplicaSetSize]">
        <SingletonPartition />
      </StatefulService>
    </Service>
    <!-- Create OrderBook Service -->
    <Service Name="OrderBook" ServiceDnsName="orderbook.exchange">
      <StatefulService ServiceTypeName="OrderBookType" TargetReplicaSetSize="[OrderBook_TargetReplicaSetSize]" MinReplicaSetSize="[OrderBook_MinReplicaSetSize]">
        <SingletonPartition />
      </StatefulService>
    </Service>
    <!-- Create Logger Service -->
    <Service Name="Logger" ServiceDnsName="logger.exchange">
      <StatefulService ServiceTypeName="LoggerType" TargetReplicaSetSize="[Logger_TargetReplicaSetSize]" MinReplicaSetSize="[Logger_MinReplicaSetSize]">
        <SingletonPartition />
      </StatefulService>
    </Service>
    <!-- Ideally ServiceDnsName would be parameterized but due to this issue: https://github.com/Azure/service-fabric-issues/issues/561
         this is not possible with DefaultServices - it would be ok if deployed using POSH, sftcl or REST.-->
  </DefaultServices>
</ApplicationManifest>