<?xml version="1.0" encoding="utf-8"?>
<ApplicationManifest xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ApplicationTypeName="ExchangeType" ApplicationTypeVersion="1.0.0" xmlns="http://schemas.microsoft.com/2011/01/fabric">
  <Parameters>
    <!--Metrics used to compare team performance and reliability against each other-->
    <Parameter Name="Metrics_AppInsights_InstrumentationKey" DefaultValue="" />
    <Parameter Name="TeamName" DefaultValue="" />
    <!-- Cluster parameters -->
    <Parameter Name="ReverseProxy_Port" DefaultValue="19081" />
    <!-- Logger parameters -->
    <Parameter Name="Logger_MinReplicaSetSize" DefaultValue="3" />
    <Parameter Name="Logger_PartitionCount" DefaultValue="1" />
    <Parameter Name="Logger_TargetReplicaSetSize" DefaultValue="3" />
    <!-- MongoDB parameters -->
    <Parameter Name="MongoGuestExe_InstanceCount" DefaultValue="1" />
    <Parameter Name="MongoConnectionString" DefaultValue="mongodb://mongo.exchange:27017" />
    <Parameter Name="MongoEnableSSL" DefaultValue="false" />
    <!-- Gateway parameters -->
    <Parameter Name="Gateway_InstanceCount" DefaultValue="1" />
    <Parameter Name="Logger_Port" DefaultValue="9082" />
    <!-- UserStore parameters -->
    <Parameter Name="UserStore_MinReplicaSetSize" DefaultValue="3" />
    <Parameter Name="UserStore_PartitionCount" DefaultValue="1" />
    <Parameter Name="UserStore_TargetReplicaSetSize" DefaultValue="3" />
    <!-- Fulfillment parameters -->
    <Parameter Name="Fulfillment_MinReplicaSetSize" DefaultValue="3" />
    <Parameter Name="Fulfillment_PartitionCount" DefaultValue="1" />
    <Parameter Name="Fulfillment_TargetReplicaSetSize" DefaultValue="3" />
    <Parameter Name="Fulfillment_Port" DefaultValue="9080" />
    <!--
    You have an SLA with management to block new trades when 800 existing trades are pending
    Changing this value with fail a system audit. Other approaches much be used to scale 
    -->
    <Parameter Name="Fulfillment_MaxTradesPending" DefaultValue="700" />
    <!-- OrderBook parameters -->
    <Parameter Name="OrderBook_MinReplicaSetSize" DefaultValue="3" />
    <Parameter Name="OrderBook_PartitionCount" DefaultValue="1" />
    <Parameter Name="OrderBook_TargetReplicaSetSize" DefaultValue="3" />
    <Parameter Name="OrderBook_Port" DefaultValue="9081" />
    <!--
    You have an SLA with management to block new orders when 200 existing orders are pending
    Changing this value with fail a system audit. Other approaches much be used to scale 
    -->
    <Parameter Name="OrderBook_MaxBidsPending" DefaultValue="130" />
    <Parameter Name="OrderBook_MaxAsksPending" DefaultValue="130" />
  </Parameters>
  <!-- Import Service Manifests -->
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="MongoGuestExePkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides />
  </ServiceManifestImport>
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="LoggerPkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides>
      <ConfigOverride Name="Config">
        <Settings>
          <Section Name="DB">
            <Parameter Name="MongoConnectionString" Value="[MongoConnectionString]" />
            <Parameter Name="MongoEnableSSL" Value="[MongoEnableSSL]" />
          </Section>
        </Settings>
      </ConfigOverride>
    </ConfigOverrides>
    <ResourceOverrides>
      <Endpoints>
        <Endpoint Name="ServiceEndpoint" Port="[Logger_Port]" />
      </Endpoints>
    </ResourceOverrides>
  </ServiceManifestImport>
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="GatewayPkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides />
  </ServiceManifestImport>
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="UserStorePkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides>
      <ConfigOverride Name="Config">
        <Settings>
          <Section Name="UserStoreConfig">
            <Parameter Name="Metrics_AppInsights_InstrumentationKey" Value="[Metrics_AppInsights_InstrumentationKey]" />
            <Parameter Name="TeamName" Value="[TeamName]" />
          </Section>
        </Settings>
      </ConfigOverride>
    </ConfigOverrides>
    <Policies>
      <RunAsPolicy CodePackageRef="Code" UserRef="LocalAdmin" />
    </Policies>
  </ServiceManifestImport>
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="FulfillmentPkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides>
      <ConfigOverride Name="Config">
        <Settings>
          <Section Name="ClusterConfig">
            <Parameter Name="ReverseProxy_Port" Value="[ReverseProxy_Port]" />
            <Parameter Name="MaxTradesPending" Value="[Fulfillment_MaxTradesPending]" />
            <Parameter Name="Metrics_AppInsights_InstrumentationKey" Value="[Metrics_AppInsights_InstrumentationKey]" />
            <Parameter Name="TeamName" Value="[TeamName]" />
          </Section>
        </Settings>
      </ConfigOverride>
    </ConfigOverrides>
    <ResourceOverrides>
      <Endpoints>
        <Endpoint Name="ServiceEndpoint" Port="[Fulfillment_Port]" />
      </Endpoints>
    </ResourceOverrides>
  </ServiceManifestImport>
  <ServiceManifestImport>
    <ServiceManifestRef ServiceManifestName="OrderBookPkg" ServiceManifestVersion="1.0.0" />
    <ConfigOverrides>
      <ConfigOverride Name="Config">
        <Settings>
          <Section Name="ClusterConfig">
            <Parameter Name="ReverseProxy_Port" Value="[ReverseProxy_Port]" />
          </Section>
          <Section Name="OrderBookConfig">
            <Parameter Name="MaxBidsPending" Value="[OrderBook_MaxBidsPending]" />
            <Parameter Name="MaxAsksPending" Value="[OrderBook_MaxAsksPending]" />
            <Parameter Name="Metrics_AppInsights_InstrumentationKey" Value="[Metrics_AppInsights_InstrumentationKey]" />
            <Parameter Name="TeamName" Value="[TeamName]" />
          </Section>
        </Settings>
      </ConfigOverride>
    </ConfigOverrides>
    <ResourceOverrides>
      <Endpoints>
        <Endpoint Name="ServiceEndpoint" Port="[OrderBook_Port]" />
      </Endpoints>
    </ResourceOverrides>
  </ServiceManifestImport>
  <DefaultServices>
    <!-- Create Gateway Service -->
    <Service Name="MongoGuestExe" ServiceDnsName="mongo.exchange" ServicePackageActivationMode="ExclusiveProcess">
      <StatelessService ServiceTypeName="MongoGuestExeType" InstanceCount="[MongoGuestExe_InstanceCount]">
        <SingletonPartition />
      </StatelessService>
    </Service>
    <Service Name="Gateway" ServicePackageActivationMode="ExclusiveProcess">
      <StatelessService ServiceTypeName="GatewayType" InstanceCount="[Gateway_InstanceCount]">
        <SingletonPartition />
      </StatelessService>
    </Service>
    <Service Name="UserStore" ServicePackageActivationMode="ExclusiveProcess">
      <StatefulService ServiceTypeName="UserStoreType" TargetReplicaSetSize="[UserStore_TargetReplicaSetSize]" MinReplicaSetSize="[UserStore_MinReplicaSetSize]">
        <UniformInt64Partition PartitionCount="[UserStore_PartitionCount]" LowKey="-9223372036854775808" HighKey="9223372036854775807" />
      </StatefulService>
    </Service>
    <!-- Create Fulfillment Service -->
    <Service Name="Fulfillment" ServiceDnsName="fulfillment.exchange" ServicePackageActivationMode="ExclusiveProcess">
      <StatefulService ServiceTypeName="FulfillmentType" TargetReplicaSetSize="[Fulfillment_TargetReplicaSetSize]" MinReplicaSetSize="[Fulfillment_MinReplicaSetSize]">
        <UniformInt64Partition PartitionCount="[Fulfillment_PartitionCount]" LowKey="-9223372036854775808" HighKey="9223372036854775807" />
      </StatefulService>
    </Service>
    <!-- Create OrderBook Service -->
    <Service Name="OrderBook" ServiceDnsName="orderbook.exchange">
      <StatefulService ServiceTypeName="OrderBookType" TargetReplicaSetSize="[OrderBook_TargetReplicaSetSize]" MinReplicaSetSize="[OrderBook_MinReplicaSetSize]">
        <SingletonPartition/>
      </StatefulService>
    </Service>
    <!-- Create Logger Service -->
    <Service Name="Logger" ServiceDnsName="logger.exchange">
      <StatefulService ServiceTypeName="LoggerType" TargetReplicaSetSize="[Logger_TargetReplicaSetSize]" MinReplicaSetSize="[Logger_MinReplicaSetSize]">
        <UniformInt64Partition PartitionCount="[Logger_PartitionCount]" LowKey="-9223372036854775808" HighKey="9223372036854775807" />
      </StatefulService>
    </Service>
    <!-- Ideally ServiceDnsName would be parameterized but due to this issue: https://github.com/Azure/service-fabric-issues/issues/561
         this is not possible with DefaultServices - it would be ok if deployed using POSH, sftcl or REST.-->
  </DefaultServices>
  <Principals>
    <Groups>
      <Group Name="LocalAdminGroup">
        <Membership>
          <SystemGroup Name="Administrators" />
        </Membership>
      </Group>
    </Groups>
    <Users>
      <User Name="LocalAdmin">
        <MemberOf>
          <Group NameRef="LocalAdminGroup" />
        </MemberOf>
      </User>
    </Users>
  </Principals>
</ApplicationManifest>